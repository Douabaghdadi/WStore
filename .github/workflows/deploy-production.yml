name: Deploy to Production VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Tests & Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json
      - run: cd frontend && npm ci && npm run build
      - run: cd backend && npm ci

  deploy:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 51.254.135.247 >> ~/.ssh/known_hosts

      - name: Git pull on VPS
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'cd /home/ubuntu/wstore && git fetch origin && git reset --hard origin/main || git reset --hard origin/master'

      - name: Fix MongoDB URLs
        continue-on-error: true
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'mongosh --quiet wstore --eval "db.products.updateMany({image:/^http:\\/\\/localhost:5000/},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://localhost:5000\",replacement:\"\"}}}}]);db.products.updateMany({image:/^http:\\/\\/51\\.254/},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://51.254.135.247:5000\",replacement:\"\"}}}}]);db.categories.updateMany({image:/^http:\\/\\//},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://localhost:5000\",replacement:\"\"}}}}]);db.categories.updateMany({image:/^http:\\/\\/51/},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://51.254.135.247:5000\",replacement:\"\"}}}}]);db.subcategories.updateMany({image:/^http:\\/\\//},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://localhost:5000\",replacement:\"\"}}}}]);db.subcategories.updateMany({image:/^http:\\/\\/51/},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://51.254.135.247:5000\",replacement:\"\"}}}}]);db.brands.updateMany({image:/^http:\\/\\//},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://localhost:5000\",replacement:\"\"}}}}]);db.brands.updateMany({image:/^http:\\/\\/51/},[{\$set:{image:{\$replaceOne:{input:\"\$image\",find:\"http://51.254.135.247:5000\",replacement:\"\"}}}}]);print(\"done\")"'

      - name: Setup backend env
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'cd /home/ubuntu/wstore/backend && ls -la .env && sed -i "s|FRONTEND_URL=.*|FRONTEND_URL=https://w-store.tn|" .env && sed -i "s|BACKEND_URL=.*|BACKEND_URL=https://w-store.tn|" .env && echo "Backend .env updated" && cat .env'

      - name: Install backend dependencies
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && echo "Node: $(node -v)" && cd /home/ubuntu/wstore/backend && npm install --production'

      - name: Setup frontend env
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'cd /home/ubuntu/wstore/frontend && echo "NEXT_PUBLIC_API_URL=https://w-store.tn" > .env.production && echo "NEXT_PUBLIC_FACEBOOK_APP_ID=1770752150168884" >> .env.production && echo "NEXT_PUBLIC_GOOGLE_CLIENT_ID=890386873007-astu30t1t91ptutf2e6asqoibb1jfnrp.apps.googleusercontent.com" >> .env.production && cat .env.production'

      - name: Clean frontend cache
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'cd /home/ubuntu/wstore/frontend && rm -rf .next node_modules/.cache && echo "Cache cleaned"'

      - name: Install frontend dependencies
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && echo "Node: $(node -v)" && cd /home/ubuntu/wstore/frontend && npm install'

      - name: Build frontend
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && export NEXT_PUBLIC_API_URL=https://w-store.tn && cd /home/ubuntu/wstore/frontend && npm run build'

      - name: Restart PM2 services
        run: |
          ssh -o ServerAliveInterval=30 ubuntu@51.254.135.247 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && pm2 delete wstore-backend 2>/dev/null; pm2 delete wstore-frontend 2>/dev/null; cd /home/ubuntu/wstore/backend && pm2 start server.js --name wstore-backend; cd /home/ubuntu/wstore/frontend && pm2 start npm --name wstore-frontend -- start; pm2 save'

      - name: Health check
        run: |
          sleep 5
          ssh ubuntu@51.254.135.247 'curl -s -o /dev/null -w "Backend: %{http_code}\n" http://localhost:5000/api/products; curl -s -o /dev/null -w "Frontend: %{http_code}\n" http://localhost:3000'
