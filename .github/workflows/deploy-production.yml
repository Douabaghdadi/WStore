name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VPS_HOST: 51.254.135.247
  VPS_USER: ubuntu
  APP_DIR: /var/www/wstore

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Lint Backend
        working-directory: ./backend
        run: npm run lint || echo "No lint script"

      - name: Lint Frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Type Check Frontend
        working-directory: ./frontend
        run: npm run build

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create .env files
        run: |
          echo "${{ secrets.BACKEND_ENV_PRODUCTION }}" > backend/.env
          echo "${{ secrets.FRONTEND_ENV_PRODUCTION }}" > frontend/.env.local

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Create deployment archive
        run: |
          tar -czf wstore-deploy-${{ github.sha }}.tar.gz \
            --exclude="node_modules" \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="*.md" \
            --exclude="*.txt" \
            --exclude="*.ps1" \
            backend \
            frontend \
            ecosystem.config.js

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wstore-deploy
          path: wstore-deploy-${{ github.sha }}.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: http://51.254.135.247
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wstore-deploy

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup on VPS
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            if [ -d "${{ env.APP_DIR }}" ]; then
              BACKUP_DIR="/var/backups/wstore"
              mkdir -p $BACKUP_DIR
              BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
              tar -czf $BACKUP_FILE -C ${{ env.APP_DIR }} . 2>/dev/null || true
              echo "Backup created: $BACKUP_FILE"
              
              # Keep only last 5 backups
              ls -t $BACKUP_DIR/backup-*.tar.gz | tail -n +6 | xargs -r rm
            fi
          EOF

      - name: Upload to VPS
        run: |
          scp wstore-deploy-${{ github.sha }}.tar.gz \
            ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/

      - name: Deploy on VPS
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Create app directory
            mkdir -p ${{ env.APP_DIR }}
            mkdir -p ${{ env.APP_DIR }}/logs
            
            # Extract new version
            cd ${{ env.APP_DIR }}
            tar -xzf /tmp/wstore-deploy-${{ github.sha }}.tar.gz
            
            # Backend setup
            echo "ðŸ“¦ Installing backend dependencies..."
            cd ${{ env.APP_DIR }}/backend
            npm ci --production
            
            # Frontend setup
            echo "ðŸ“¦ Installing frontend dependencies..."
            cd ${{ env.APP_DIR }}/frontend
            npm ci --production
            
            # Restart applications
            echo "ðŸ”„ Restarting applications..."
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
            pm2 save
            
            # Cleanup
            rm /tmp/wstore-deploy-${{ github.sha }}.tar.gz
            
            echo "âœ… Deployment completed successfully!"
            pm2 status
          EOF

      - name: Health Check
        run: |
          echo "ðŸ¥ Running health checks..."
          
          # Wait for services to start
          sleep 10
          
          # Check frontend
          if curl -f http://${{ env.VPS_HOST }}:3000 > /dev/null 2>&1; then
            echo "âœ… Frontend is healthy"
          else
            echo "âŒ Frontend health check failed"
            exit 1
          fi
          
          # Check backend
          if curl -f http://${{ env.VPS_HOST }}:5000/api/products > /dev/null 2>&1; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "Frontend: http://${{ env.VPS_HOST }}:3000"
            echo "Backend: http://${{ env.VPS_HOST }}:5000"
          else
            echo "âŒ Deployment failed!"
          fi

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: failure()
    needs: deploy
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Restore from backup
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            BACKUP_DIR="/var/backups/wstore"
            LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup-*.tar.gz | head -n 1)
            
            if [ -f "$LATEST_BACKUP" ]; then
              echo "ðŸ”„ Rolling back to: $LATEST_BACKUP"
              cd ${{ env.APP_DIR }}
              tar -xzf $LATEST_BACKUP
              pm2 restart all
              echo "âœ… Rollback completed"
            else
              echo "âŒ No backup found"
              exit 1
            fi
          EOF
